

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>processor.DldProcessor &mdash; hextof-processor 1.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="hextof-processor 1.0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> hextof-processor
          

          
          </a>

          
            
            
              <div class="version">
                1.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Processor library API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../library/DldFlashDataframeCreator.html">1. Dataframe creator class (DldFlashDataframeCreator)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/DldProcessor.html">2. DldProcessor class (DldProcessor)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/pah.html">3. Interfacing external pah library</a></li>
</ul>
<p class="caption"><span class="caption-text">Utilities API (user contribution)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../library/utils/calibration.html">1. Calibration (processor.utilities.calibration)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/utils/diagnostics.html">2. Diagnostics (processor.utilities.diagnostics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/utils/masking.html">3. Miscellaneous (processor.utilities.MaskingTool)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/utils/vis.html">4. Miscellaneous (processor.utilities.vis)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/utils/io.html">5. Input/Output (processor.utilities.io)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/utils/misc.html">6. Miscellaneous (processor.utilities.misc)</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../example/01_readdaq.html">1. Read DAQ data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example/02_parquet.html">2. Save dataset to dask parquet files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example/03_binning.html">3. Binning multidimensional data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example/04_nobinning.html">4. Processing data without binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example/05_corrections.html">5. Corrections to FEL pulse timing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example/06_fullexample.html">6. Complete code examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/listofterms.html">1. List of terms and abbreviations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/howtomaintain.html">2. Package maintenance</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hextof-processor</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>processor.DldProcessor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for processor.DldProcessor</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>  <span class="c1"># avoid printing FutureWarnings from other packages</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">tqdm_notebook</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">from</span> <span class="nn">processor.utilities</span> <span class="kn">import</span> <span class="n">misc</span><span class="p">,</span> <span class="n">io</span>
<span class="c1"># warnings.resetwarnings()</span>

<span class="n">_VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="DldProcessor"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor">[docs]</a><span class="k">class</span> <span class="nc">DldProcessor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class simplifies the analysis of data files recorded during the</span>
<span class="sd">    beamtime of August 2017. It converts the electrons from the DLD into</span>
<span class="sd">    a clean table and uses DASK for binning and further analysis.</span>
<span class="sd">    </span>
<span class="sd">    :Attributes (loaded from SETTINGS.ini):</span>
<span class="sd">        N_CORES : int</span>
<span class="sd">            The number of available CPU cores to use.</span>
<span class="sd">        CHUNK_SIZE : int</span>
<span class="sd">            Size of the chunks in which a parquet file will be divided.</span>
<span class="sd">        TOF_STEP_NS : float</span>
<span class="sd">            The step size in ns of the dldTime. Used to convert the</span>
<span class="sd">            step number to the ToF time in the delay line detector.</span>
<span class="sd">        TOF_STEP_EV : float</span>
<span class="sd">            The step size in eV of the dldTime. Used to convert the</span>
<span class="sd">            step number to energy of the photoemitted electrons.</span>
<span class="sd">        DATA_RAW_DIR : str</span>
<span class="sd">            Path to raw data hdf5 files output by FLASH</span>
<span class="sd">        DATA_PARQUET_DIR : str</span>
<span class="sd">            Path to where parquet files are stored.</span>
<span class="sd">        DATA_H5_DIR : str</span>
<span class="sd">            Path to where hdf5 files containing binned data are stored.</span>
<span class="sd">        DATA_RESULTS_DIR : str</span>
<span class="sd">            Path to default saving location for results in np.array,</span>
<span class="sd">            tiff stack formats etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create and manage a dask DataFrame from the data recorded at FLASH.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadSettings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initAttributes</span><span class="p">()</span>  <span class="c1"># in else because it is called already in load_settings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resetBins</span><span class="p">()</span>

        <span class="c1"># initialize attributes for metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># this should contain &#39;name&#39;, &#39;sampleID&#39;, &#39;cleave number&#39; etc...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runInfo</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;runNumber&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runNumber</span><span class="p">,</span>
                    <span class="s1">&#39;pulseIdInterval&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="n">md</span><span class="p">[</span><span class="s1">&#39;processor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_cores&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_CORES</span><span class="p">,</span>
                           <span class="s1">&#39;chunk_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">,</span>
                               <span class="p">}</span>
            <span class="n">md</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TOF_STEP_TO_NS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span><span class="p">,</span>
                                 <span class="s1">&#39;ET_CONV_E_OFFSET&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ET_CONV_E_OFFSET</span><span class="p">,</span>
                                 <span class="s1">&#39;ET_CONV_T_OFFSET&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ET_CONV_T_OFFSET</span><span class="p">,</span>
                                 <span class="s1">&#39;ET_CONV_L&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ET_CONV_L</span><span class="p">,</span>
                                 <span class="s1">&#39;TOF_IN_NS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_IN_NS</span><span class="p">,</span>
                                 <span class="p">}</span>
            <span class="n">md</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;DATA_RAW_DIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_RAW_DIR</span><span class="p">,</span>
                <span class="s1">&#39;DATA_H5_DIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_H5_DIR</span><span class="p">,</span>
                <span class="s1">&#39;DATA_PARQUET_DIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_PARQUET_DIR</span><span class="p">,</span>
                <span class="s1">&#39;DATA_RESULTS_DIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_RESULTS_DIR</span><span class="p">,</span>
                <span class="s1">&#39;LOG_DIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOG_DIR</span><span class="p">,</span>
                <span class="s1">&#39;PAH_MODULE_DIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAH_MODULE_DIR</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="c1"># md[&#39;DAQ channels&#39;] =</span>
            <span class="n">md</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">md</span>
        <span class="k">return</span> <span class="n">md</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Easy access to settings.ini file</span>

<span class="sd">        Returns:</span>
<span class="sd">            dictionary with the settings file structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;SETTINGS.ini&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_folder</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;setup.py&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_folder</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SettingsInitializationError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root_folder</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;setup.py&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_folder</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">SettingsInitializationError</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s1">&#39;SETTINGS.ini&#39;</span><span class="p">)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">sections</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed loading main settings!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">settings</span>

<div class="viewcode-block" id="DldProcessor.initAttributes"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.initAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">initAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse settings file and assign the variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            import_all: bool | False</span>
<span class="sd">                Option to import method selection.\n</span>
<span class="sd">                ``True`` imports all entries in SETTINGS.ini except those from sections [DAQ channels].</span>
<span class="sd">                These are handled in the DldFlashProcessor subclass. Prints a warning when an entry</span>
<span class="sd">                is not found as class attribute\n</span>
<span class="sd">                ``False`` only imports those that match existing attribute names.</span>
<span class="sd">        Warnings:</span>
<span class="sd">            UserWarning:</span>
<span class="sd">                when an entry is found in the SETTINGS.ini file, which</span>
<span class="sd">                is not present as a pre-defined class attribute, it warns the</span>
<span class="sd">                user to add id to the code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Hard coded class attributes which can be overwritten by settings files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_CORES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UBID_OFFSET</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.020576131995767355</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ET_CONV_E_OFFSET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">357.7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ET_CONV_T_OFFSET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">82.7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ET_CONV_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">.</span><span class="mi">75</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K_CENTER_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">668</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K_CENTER_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">658</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K_RADIUS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">230</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K_ROTATION_ANGLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">STEP_TO_K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TOF_IN_NS</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RETURN_XARRAY</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SINGLE_CORE_DATAFRAME_CREATION</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">DATA_RAW_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;/gpfs/pg2/current/raw/hdf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DATA_H5_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;/home/pg2user/data/h5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DATA_PARQUET_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;/home/pg2user/DATA/parquet/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DATA_RESULTS_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;/home/pg2user/DATA/results/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOG_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;/home/pg2user/DATA/logs/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAH_MODULE_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># parse the currently loaded settings file and store as class attributes</span>
        <span class="c1"># each entry which is not in DAQ channels. Those are handled in the</span>
        <span class="c1"># DldFlashProcessor class.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sec_name</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sec_name</span> <span class="o">!=</span> <span class="s1">&#39;DAQ channels&#39;</span><span class="p">:</span>  <span class="c1"># ignore the DAQ channels</span>
                    <span class="k">for</span> <span class="n">entry_name</span><span class="p">,</span> <span class="n">entry_value</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>  <span class="c1"># try assigning numeric values</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">type_</span><span class="p">(</span><span class="n">entry_value</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">entry_value</span>
                            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AUTO&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">]:</span>  <span class="c1"># add option for ignoring value.</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">old_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
                                <span class="n">new_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">old_type</span> <span class="o">!=</span> <span class="n">new_type</span><span class="p">:</span>
                                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;Setting </span><span class="si">{</span><span class="n">entry_name</span><span class="si">}</span><span class="s1"> found as </span><span class="si">{</span><span class="n">new_type</span><span class="si">}</span><span class="s1"> instead of the expected </span><span class="si">{</span><span class="n">old_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">val</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">import_all</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">val</span><span class="p">)</span>
                                <span class="k">elif</span>  <span class="n">_VERBOSE</span><span class="p">:</span>
                                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;Found new setting </span><span class="si">{</span><span class="n">entry_name</span><span class="si">}</span><span class="s1">. Consider adding to hard coded defaults for correct&#39;</span>
                                        <span class="sa">f</span><span class="s1">&#39;type and error handling.&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">pass</span>
        <span class="k">except</span> <span class="n">SettingsInitializationError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;========================================================&#39;</span>
                  <span class="s1">&#39;No Settings file found. Initializing to default settings&#39;</span>
                  <span class="s1">&#39;========================================================&#39;</span><span class="p">)</span>
            <span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;setup.py&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_folder</span><span class="p">):</span>
                <span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root_folder</span><span class="p">)</span>
            <span class="n">default_settings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">)</span>
            <span class="n">default_settings</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">default_settings</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">default_settings_file</span><span class="p">)</span>
            <span class="n">settings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s1">&#39;SETTINGS.ini&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">SETTINGS_file</span><span class="p">:</span>  <span class="c1"># overwrite SETTINGS.ini with the new settings</span>
                <span class="n">default_settings</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SETTINGS_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initAttributes</span><span class="p">()</span></div>

<div class="viewcode-block" id="DldProcessor.loadSettings"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.loadSettings">[docs]</a>    <span class="k">def</span> <span class="nf">loadSettings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_file_name</span><span class="p">,</span> <span class="n">preserve_path</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load settings from an other saved setting file.</span>

<span class="sd">        To save settings simply copy paste the SETTINGS.ini file to the</span>
<span class="sd">        utilities/settings folder, and rename it. Use this name in this method</span>
<span class="sd">        to then load its content to the SETTINGS.ini file.</span>

<span class="sd">        Args:</span>
<span class="sd">            settings_file_name: str</span>
<span class="sd">                Name of the settings file to load.</span>
<span class="sd">                This file must be in the folder &quot;hextof-processor/utilities/settings&quot;.</span>
<span class="sd">            preserve_path: bool | True</span>
<span class="sd">                Disables overwriting local file saving paths. Defaults to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;SETTINGS.ini&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_folder</span><span class="p">):</span>
            <span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root_folder</span><span class="p">)</span>
        <span class="n">old_settings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s1">&#39;SETTINGS.ini&#39;</span><span class="p">)</span>
        <span class="n">new_settings</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">settings_file_name</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.ini&#39;</span><span class="p">:</span>
            <span class="n">settings_file_name</span> <span class="o">+=</span> <span class="s1">&#39;.ini&#39;</span>
        <span class="n">new_settings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="n">settings_file_name</span><span class="p">)</span>
        <span class="n">new_settings</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">new_settings_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_settings</span><span class="o">.</span><span class="n">sections</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No settings file </span><span class="si">{</span><span class="n">settings_file_name</span><span class="si">}</span><span class="s1"> found.&#39;</span><span class="p">)</span>
            <span class="n">available_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s1">&#39;settings&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Available settings files are:&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">available_settings</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">preserve_path</span><span class="p">:</span>
                <span class="n">old_settings</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
                <span class="n">old_settings</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_settings_file</span><span class="p">)</span>
                <span class="n">new_settings</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_settings</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_settings_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">SETTINGS_file</span><span class="p">:</span>  <span class="c1"># overwrite SETTINGS.ini with the new settings</span>
                <span class="n">new_settings</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SETTINGS_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded settings from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings_file_name</span><span class="p">))</span></div>
            <span class="c1"># reload settings in the current processor instance</span>
    <span class="c1"># ==================</span>
    <span class="c1"># Dataframe creation</span>
    <span class="c1"># ==================</span>

<div class="viewcode-block" id="DldProcessor.readDataframes"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.readDataframes">[docs]</a>    <span class="k">def</span> <span class="nf">readDataframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load data from a parquet or HDF5 dataframe.</span>

<span class="sd">        Access the data as hdf5 file (this is the format used internally,</span>
<span class="sd">        NOT the FLASH HDF5 files obtained from the DAQ system!)</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            fileName : str | None</span>
<span class="sd">                Shared namestring of data file.</span>
<span class="sd">            path : str | None (default to ``self.DATA_PARQUET_DIR`` or ``self.DATA_H5_DIR``)</span>
<span class="sd">                name of the filepath (down to the lowest-level folder)</span>
<span class="sd">            format : str | &#39;parquet&#39;</span>
<span class="sd">                file format, &#39;parquet&#39; (parquet file), &#39;h5&#39; or &#39;hdf5&#39; (hdf5 file).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;parquet&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">,</span> <span class="s1">&#39;hdf5&#39;</span><span class="p">],</span> <span class="s1">&#39;Invalid format for data input. Please select between parquet or h5.&#39;</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;parquet&#39;</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_PARQUET_DIR</span>
            <span class="k">elif</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">]:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_H5_DIR</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runNumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;mb</span><span class="si">{}</span><span class="s1">to</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runNumber</span><span class="p">)</span>
        <span class="n">fullName</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">fileName</span>  <span class="c1"># TODO: test if naming is correct</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;parquet&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fullName</span> <span class="o">+</span> <span class="s2">&quot;_el&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fullName</span> <span class="o">+</span> <span class="s2">&quot;_mb&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullName</span> <span class="o">+</span> <span class="s1">&#39;_el&#39;</span><span class="p">,</span> <span class="s1">&#39;run_metadata.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed loading metadata from parquet stored files!, </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span>
                <span class="n">fullName</span><span class="p">,</span> <span class="s1">&#39;/electrons&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span>
                <span class="n">fullName</span><span class="p">,</span> <span class="s1">&#39;/microbunches&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printRunOverview</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded data form </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s1"> file&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DldProcessor.appendDataframeParquet"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.appendDataframeParquet">[docs]</a>    <span class="k">def</span> <span class="nf">appendDataframeParquet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Append data to an existing dask Parquet dataframe.</span>

<span class="sd">        This can be used to concatenate multiple DAQ runs in one dataframe.</span>
<span class="sd">        Data is taken from the dd and dd_microbunch dataframe attributes.</span>

<span class="sd">        :Parameter:</span>
<span class="sd">            fileName : str</span>
<span class="sd">                name (including path) of the folder containing the</span>
<span class="sd">                parquet files to append the new data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span>
                <span class="n">fileName</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># if runNumber is given (only works if the run was prevously stored with default naming)</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_PARQUET_DIR</span>
        <span class="n">fullName</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">fileName</span>
        <span class="n">newdd</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fullName</span> <span class="o">+</span> <span class="s2">&quot;_el&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">,</span> <span class="n">newdd</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">interleave_partitions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">newddMicrobunches</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">fullName</span> <span class="o">+</span> <span class="s2">&quot;_mb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">,</span> <span class="n">newddMicrobunches</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span>
                                                    <span class="n">interleave_partitions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">binnedArrayShape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">binnedArraySize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span>

<div class="viewcode-block" id="DldProcessor.printRunOverview"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.printRunOverview">[docs]</a>    <span class="k">def</span> <span class="nf">printRunOverview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print run information, used in readData and readDataParquet </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runInfo</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dict</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>                
            
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no run info available.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Run </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;runNumber&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started at </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;timeStart&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, finished at </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;timeStop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;total duration </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;timeDuration&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Macrobunches: </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;numberOfMacrobunches&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">  &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;pulseIdInterval&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;pulseIdInterval&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total electrons: </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;numberOfElectrons&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;electrons/Macrobunch </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;electronsPerMacrobunch&#39;</span><span class="p">]</span><span class="si">:}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="c1"># ==========================</span>
    <span class="c1"># Dataframe column expansion</span>
    <span class="c1"># ==========================</span>

<div class="viewcode-block" id="DldProcessor.postProcess"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.postProcess">[docs]</a>    <span class="k">def</span> <span class="nf">postProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bamCorrectionSign</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kCenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bamCentered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply corrections to the dataframe.</span>

<span class="sd">        Runs the methods to post-process the dataframe. Includes BAM sign</span>
<span class="sd">        correction and polar coordinates axes generation.</span>

<span class="sd">        ``/!\`` BAM correction is tricky and will mess up the delay histogram.</span>
<span class="sd">        This is because of strong correlation with microbunch ID of both the</span>
<span class="sd">        BAM value and the photoemission yield, i.e. photons at the end of a</span>
<span class="sd">        macrobunch give more photoelectrons while being systematically</span>
<span class="sd">        shifted in time.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            bamCorrectionSign : int | 0</span>
<span class="sd">                Sign of to the BAM correction.</span>
<span class="sd">                Use None to have no correction and no name change.</span>
<span class="sd">                See ``correctBAM`` for details.</span>
<span class="sd">            kCenter : (int, int) | None</span>
<span class="sd">                position of the center of k-space in the DLD detector array.</span>
<span class="sd">                If set to None, no polar coordinates are added.</span>
<span class="sd">                See createPolarCoordinates for details.            </span>
<span class="sd">            bamCentered : boolean | False</span>
<span class="sd">                BAM correction will be centered to mean BAM value.</span>
<span class="sd">                See ``correctBAM`` for details</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bamCorrectionSign</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correctBAM</span><span class="p">(</span><span class="n">sign</span><span class="o">=</span><span class="n">bamCorrectionSign</span><span class="p">,</span><span class="n">centered</span><span class="o">=</span><span class="n">bamCentered</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kCenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createPolarCoordinates</span><span class="p">(</span><span class="n">kCenter</span><span class="p">)</span></div>

<div class="viewcode-block" id="DldProcessor.correctBAM"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.correctBAM">[docs]</a>    <span class="k">def</span> <span class="nf">correctBAM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;delayStage&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Correct pump probe time by BAM (beam arrival monitor) data.</span>

<span class="sd">        Corrects the pulse to pulse jitter, and changes name from</span>
<span class="sd">        delayStageTime to pumpProbeTime. BAM correction shifts the time delay</span>
<span class="sd">        by a constant value.</span>

<span class="sd">        ``/!\`` BAM correction is tricky and will mess up the delay histogram.</span>
<span class="sd">        This is because of strong correlation with the microbunch ID of both the</span>
<span class="sd">        BAM value and the photoemission yield, i.e. photons at the end of a</span>
<span class="sd">        macrobunch give more photoelectrons while becoming systematically</span>
<span class="sd">        shifted in time.</span>

<span class="sd">        Default value is 1 since the BAM measures the delay between the master</span>
<span class="sd">        clock start and the arrival of the beam.</span>
<span class="sd">        </span>
<span class="sd">        On the other hand, more positive delay stage values are for when the FEL</span>
<span class="sd">        arrives earlier (FEL before pump is on the more positive side of t0).</span>
<span class="sd">        A bigger delay in beam arrival for an FEL pulse means that the photoelectrons</span>
<span class="sd">        actually had a more negative delay (probe later than pump) than what the delay stage</span>
<span class="sd">        measured, and should therefore be moved to more negative values.</span>

<span class="sd">        :Parameter:</span>
<span class="sd">            sign : int</span>
<span class="sd">                Sign multiplier for BAM correction. Avoid using -1 unless debugging.</span>
<span class="sd">                </span>
<span class="sd">                =======  =====================================</span>
<span class="sd">                Value    Operation    </span>
<span class="sd">                =======  =====================================</span>
<span class="sd">                 0       no correction  </span>
<span class="sd">                 1       pumpProbeTime = delayStage - bam</span>
<span class="sd">                -1       pumpProbeTime = delayStage + bam</span>
<span class="sd">                =======  =====================================</span>
<span class="sd">            centered : boolean</span>
<span class="sd">                BAM correction is done either by the absulut value or the differens to </span>
<span class="sd">                the mean value.</span>
<span class="sd">                </span>
<span class="sd">                =======  =====================================</span>
<span class="sd">                Value    Operation    </span>
<span class="sd">                =======  =====================================</span>
<span class="sd">                 True    pumpProbeTime = delayStage - (bam-bam.mean) </span>
<span class="sd">                 False   pumpProbeTime = delayStage - bam</span>
<span class="sd">                =======  ===================================== </span>
<span class="sd">            source : str</span>
<span class="sd">                channel to apply the BAM correction. Default is the &#39;delayStage&#39; channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">-</span> \
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">centered</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">*</span> <span class="n">sign</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">-</span> \
                                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">centered</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">*</span> <span class="n">sign</span></div>
<div class="viewcode-block" id="DldProcessor.delayStageMovingDirection"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.delayStageMovingDirection">[docs]</a>    <span class="k">def</span> <span class="nf">delayStageMovingDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate the direction of movement of the delay stage. </span>
<span class="sd">        Needed for backlash of the 1030nm Laser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        <span class="k">if</span> <span class="ow">not</span><span class="s1">&#39;delayStageDirection&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">MId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;macroBunchPulseId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">delayStage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;delayStage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

            <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">MId</span><span class="p">)</span>
            <span class="n">delayStage_c</span><span class="o">=</span><span class="n">delayStage</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">MId_c</span><span class="o">=</span><span class="n">MId</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">delayStage_c</span><span class="p">)</span>
            <span class="n">delayStage_c</span><span class="o">=</span><span class="n">delayStage_c</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">MId_c</span><span class="o">=</span><span class="n">MId_c</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">delayStage_c</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span>
            <span class="n">delayStage_0</span><span class="o">=</span><span class="n">delayStage_c</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">MId_0</span><span class="o">=</span><span class="n">MId_c</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">delayStage_0</span><span class="p">)</span>
            <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">f</span><span class="o">=</span><span class="n">interp1d</span><span class="p">(</span><span class="n">MId_0</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            
            <span class="k">def</span> <span class="nf">interpolateMovement</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">macroBunchPulseId</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;delayStageDirection&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">macroBunchPulseId</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>
            <span class="c1">#self.ddMicrobunches[&#39;delayStageDirection&#39;]=self.ddMicrobunches.macroBunchPulseId.map_partitions(f) #solve fist: macroBunchPulseID is not identical in range for both dataframes</span>
                  
<div class="viewcode-block" id="DldProcessor.correctBackLash"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.correctBackLash">[docs]</a>    <span class="k">def</span> <span class="nf">correctBackLash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backLash</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;delayStage&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shift the delay time of the up and down moving in different directions </span>
<span class="sd">        to compensate backlash.</span>
<span class="sd">        :Parameter:</span>
<span class="sd">            backLash : float </span>
<span class="sd">                Value to shift </span>
<span class="sd">            source : str</span>
<span class="sd">                channel to apply the BAM correction. Default is the &#39;delayStage&#39; channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">-</span> \
                                   <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;delayStageDirection&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">backLash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="c1"># - \</span></div>
        <span class="c1">#                                       self.ddMicrobunches[&#39;delayStageDirection&#39;]*backLash      </span>
        
<div class="viewcode-block" id="DldProcessor.calibrateEnergy"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.calibrateEnergy">[docs]</a>    <span class="k">def</span> <span class="nf">calibrateEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eoffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useAvgSampleBias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">k_shift_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">k_shift_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">applyJitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jitterAmplitude</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">jitterType</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add calibrated energy axis to dataframe</span>

<span class="sd">        Uses the same equation as in tof2energy in calibrate.</span>

<span class="sd">        Args:</span>
<span class="sd">            toffset : float</span>
<span class="sd">                The time offset from the dld clock start to when the fastest photoelectrons reach the detector</span>
<span class="sd">            eoffset : float</span>
<span class="sd">                The energy offset given by W-hv-V</span>
<span class="sd">            l : float</span>
<span class="sd">                the effective length of the drift section</span>
<span class="sd">            useAvgSampleBias: bool (False)</span>
<span class="sd">                uses the average value for the sample bias across the dataset,</span>
<span class="sd">                possibly reducing noise, but cannot be used on runs where the</span>
<span class="sd">                sample bias was changed</span>
<span class="sd">            k_shift_func : function</span>
<span class="sd">                function fitting the shifts of energy across the detector.</span>
<span class="sd">            k_shift_parameters :</span>
<span class="sd">                parameters for the fit function to reproduce the energy shift.</span>
<span class="sd">            applyJitter : bool (True)</span>
<span class="sd">                if true, applies random noise of amplitude determined by jitterAmplitude</span>
<span class="sd">                to the dldTime step values.</span>
<span class="sd">            jitterType :</span>
<span class="sd">                noise distribution, &#39;uniform&#39; or &#39;normal&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">toffset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">toffset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;processor&#39;</span><span class="p">][</span><span class="s1">&#39;ET_CONV_T_OFFSET&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">eoffset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eoffset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;processor&#39;</span><span class="p">][</span><span class="s1">&#39;ET_CONV_E_OFFSET&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;processor&#39;</span><span class="p">][</span><span class="s1">&#39;ET_CONV_L&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldTime_corrected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldTime&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;dldSectorId&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldTime_corrected&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldSectorId&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">correct_dldTime_shift</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">func</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dldPosX&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dldPosY&#39;</span><span class="p">]),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_IN_NS</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">/=</span> <span class="mf">0.020576131995767355</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="k">if</span> <span class="n">k_shift_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k_shift_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldTime_corrected&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">correct_dldTime_shift</span><span class="p">,</span> <span class="n">k_shift_func</span><span class="p">,</span>
                                                                 <span class="o">*</span><span class="n">k_shift_parameters</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">applyJitter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldTime_corrected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">dfops</span><span class="o">.</span><span class="n">applyJitter</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="n">jitterAmplitude</span><span class="p">,</span>
                                                                  <span class="n">col</span><span class="o">=</span><span class="s1">&#39;dldTime_corrected&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">jitterType</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">useAvgSampleBias</span><span class="p">:</span>
            <span class="n">eoffset</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;sampleBias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eoffset</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;sampleBias&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">useAvgMonochormatorEnergy</span><span class="p">:</span>        <span class="c1"># TODO: add monocrhomator position,</span>
            <span class="n">eoffset</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;monochromatorEnergy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eoffset</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;monochromatorEnergy&#39;</span><span class="p">]</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mf">1e18</span> <span class="o">*</span> <span class="mf">9.10938e-31</span> <span class="o">/</span> <span class="mf">1.602177e-19</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldTime_corrected&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span><span class="p">)</span> <span class="o">-</span> <span class="n">toffset</span><span class="p">),</span>
                                         <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">eoffset</span></div>

<div class="viewcode-block" id="DldProcessor.calibratePumpProbeTime"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.calibratePumpProbeTime">[docs]</a>    <span class="k">def</span> <span class="nf">calibratePumpProbeTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bamSign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">streakSign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">invertTimeAxis</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Add pumpProbeTime axis to dataframes.</span>

<span class="sd">        Correct pump probe time by BAM and/or streak camera</span>

<span class="sd">        Args:</span>
<span class="sd">            t0: float</span>
<span class="sd">                pump probe time overlap</span>
<span class="sd">            bamSign: -1,+1</span>
<span class="sd">                sign of the bam correction:</span>
<span class="sd">                    +1 : pumpProbeTime =  delayStage + bam</span>
<span class="sd">                    -1 : pumpProbeTime =  delayStage - bam</span>
<span class="sd">                     0 : ignore bam correction</span>
<span class="sd">            streakSign: -1,0,+1</span>
<span class="sd">                sign of the bam correction:</span>
<span class="sd">                    +1 : pumpProbeTime =  delayStage + streakCam</span>
<span class="sd">                    -1 : pumpProbeTime =  delayStage - streakCam</span>
<span class="sd">                     0 : ignore streakCamera correction</span>
<span class="sd">            invertTimeAxis: bool (True)</span>
<span class="sd">                invert time direction on pump probe time</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;delayStage&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span>

            <span class="k">if</span> <span class="s1">&#39;bam&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bamSign</span>
            <span class="k">if</span> <span class="s1">&#39;streakCamera&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;streakCamera&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">streakSign</span>
            <span class="k">if</span> <span class="n">invertTimeAxis</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DldProcessor.calibrateMomentum"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.calibrateMomentum">[docs]</a>    <span class="k">def</span> <span class="nf">calibrateMomentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kCenterX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kCenterY</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotationAngle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">px_to_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">createPolarCoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">applyJitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jitterAmp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">jitterType</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add calibrated parallel momentum axes to dataframe.</span>

<span class="sd">        Compute the calibration of parallel momentum kx and ky from the detector</span>
<span class="sd">        position dldPosX and dldPosY. Optionally, add columns with thethe polar</span>
<span class="sd">        coordinates kr and kt.</span>

<span class="sd">        Uses the same equation as in tof2energy in calibrate.</span>
<span class="sd">        Args:</span>
<span class="sd">            kCenterX : float</span>
<span class="sd">                dldPosX coordinate of the center of k-space</span>
<span class="sd">            kCenterY : float</span>
<span class="sd">                dldPosY coordinate of the center of k-space</span>
<span class="sd">            rotationAngle : float</span>
<span class="sd">                Rotates the momentum coordinates counterclockwise</span>
<span class="sd">            px_to_k : float</span>
<span class="sd">                Conversion between dldPosX/Y to momentum in inverse Angstroms</span>
<span class="sd">            createPolarCoords: bool (True)</span>
<span class="sd">                If True, also creates the polar momentum coordinates kr and kt</span>
<span class="sd">            applyJitter: bool (True)</span>
<span class="sd">                Apply jitter on the original axis to reduce artifacts when binning.</span>
<span class="sd">                This is especially necessary when rotating the momentum coordinates.</span>
<span class="sd">            jitterAmp: float</span>
<span class="sd">                Amplitude of the random jitter applied. Best kept at half the</span>
<span class="sd">                axis original spacing. In case of dldPosX and Y, this should be</span>
<span class="sd">                kept at 0.5, since they are integer steps.</span>
<span class="sd">            jitterType: &#39;uniform&#39;</span>
<span class="sd">                Choose between &#39;uniform&#39; or &#39;normal&#39; random distributions. With</span>
<span class="sd">                 regularly spaced axes as here, uniform is preferred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kCenterX</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kCenterX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_CENTER_X</span>
        <span class="k">if</span> <span class="n">kCenterY</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kCenterY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_CENTER_Y</span>
        <span class="k">if</span> <span class="n">rotationAngle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rotationAngle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_ROTATION_ANGLE</span>
        <span class="k">if</span> <span class="n">px_to_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">px_to_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STEP_TO_K</span>

        <span class="k">if</span> <span class="n">applyJitter</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">dfops</span><span class="o">.</span><span class="n">applyJitter</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="n">jitterAmp</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;dldPosX&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">jitterType</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
                <span class="n">kCenterX</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">dfops</span><span class="o">.</span><span class="n">applyJitter</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="n">jitterAmp</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;dldPosY&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">jitterType</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span>
                <span class="n">kCenterY</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldPosX&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">kCenterX</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldPosY&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">kCenterY</span><span class="p">)</span>
        <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rotationAngle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rotationAngle</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;kx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_to_k</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">cos</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">sin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ky&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_to_k</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span> <span class="n">X</span> <span class="o">*</span> <span class="n">sin</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">cos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">createPolarCoords</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;kx&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ky&#39;</span><span class="p">]))</span>

            <span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ky&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;kx&#39;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;kr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;kt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span></div>

<div class="viewcode-block" id="DldProcessor.createPolarCoordinates"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.createPolarCoordinates">[docs]</a>    <span class="k">def</span> <span class="nf">createPolarCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kCenter</span><span class="o">=</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot; Calculate polar coordinates for k-space values.</span>

<span class="sd">        :Parameter:</span>
<span class="sd">            kCenter : (int,int) | (250, 250)</span>
<span class="sd">                Pixel position of the k-space center in the DLD array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dldPosX</span> <span class="o">-</span> <span class="n">kCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dldPosY</span> <span class="o">-</span> <span class="n">kCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">posY</span> <span class="o">-</span> <span class="n">kCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">posX</span> <span class="o">-</span> <span class="n">kCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldPosR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dldPosT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span></div>

    <span class="c1"># ========================</span>
    <span class="c1"># Normalization histograms</span>
    <span class="c1"># ========================</span>

<div class="viewcode-block" id="DldProcessor.normalizePumpProbeTime"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.normalizePumpProbeTime">[docs]</a>    <span class="k">def</span> <span class="nf">normalizePumpProbeTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">,</span><span class="n">preserve_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: work on better implementation and accessibility for this method</span>
        <span class="sd">&quot;&quot;&quot; Normalizes the data array to the number of counts per delay stage step.</span>
<span class="sd">            [DEPRECATED] this is buggy... the new normalizeDelay function should be used</span>
<span class="sd">        :Parameter:</span>
<span class="sd">            data_array : numpy array</span>
<span class="sd">                data array containing binned data, as created by the ``computeBinnedData`` method.</span>
<span class="sd">            ax : str | &#39;pumpProbeTime&#39;</span>
<span class="sd">                axis name</span>
<span class="sd">                </span>
<span class="sd">        :Raise:</span>
<span class="sd">            Throw a ValueError when no pump probe time delay axis is available.</span>

<span class="sd">        :Return:</span>
<span class="sd">            data_array_normalized : numpy array</span>
<span class="sd">                normalized version of the input array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the index of the normalization axis</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">norm_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayStageHistogram</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">norm_array</span> <span class="o">=</span> <span class="n">norm_array</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;normalized pumpProbe data found along axis </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">data_array_normalized</span> <span class="o">/</span> <span class="n">norm_array</span>
            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">data_array_normalized</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;No pump probe time bin, could not normalize to delay stage histogram.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DldProcessor.normalizeDelay"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.normalizeDelay">[docs]</a>    <span class="k">def</span> <span class="nf">normalizeDelay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preserve_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Normalizes the data array to the number of counts per delay stage step.</span>

<span class="sd">        :Parameter:</span>
<span class="sd">            data_array : numpy array</span>
<span class="sd">                data array containing binned data, as created by the ``computeBinnedData`` method.</span>
<span class="sd">            ax : str</span>
<span class="sd">                name of the axis to normalize to, default is None, which uses as</span>
<span class="sd">                normalization axis &quot;pumpProbeTime&quot; if found, otherwise &quot;delayStage&quot;</span>
<span class="sd">            preserve_mean : bool | True</span>
<span class="sd">                if True, divides the histogram by its mean, preserving the average value of the </span>
<span class="sd">                normalized array.   </span>
<span class="sd">        :Raise:</span>
<span class="sd">            Throw a ValueError when no pump probe time delay axis is available.</span>

<span class="sd">        :Return:</span>
<span class="sd">            data_array_normalized : numpy array</span>
<span class="sd">                normalized version of the input array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;pumpProbeTime&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">=</span><span class="s1">&#39;pumpProbeTime&#39;</span>
                <span class="n">nhist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pumpProbeTimeHistogram</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s1">&#39;delayStage&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">=</span><span class="s1">&#39;delayStage&#39;</span>
                <span class="n">nhist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayStageHistogram</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No axis pump probe or delay stage histogram found, could not normalize.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nhist</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1">Histogram&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No axis </span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1"> histogram found, could not normalize.&#39;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;normalized </span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s1"> data found along axis </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">nhist</span> <span class="o">=</span> <span class="n">nhist</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            
        <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">data_array_normalized</span> <span class="o">/</span> <span class="n">nhist</span>
        <span class="k">if</span> <span class="n">preserve_mean</span><span class="p">:</span>
            <span class="n">data_array_normalized</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nhist</span><span class="p">)</span>
        <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_array_normalized</span></div>


<div class="viewcode-block" id="DldProcessor.normalizeGMD"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.normalizeGMD">[docs]</a>    <span class="k">def</span> <span class="nf">normalizeGMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">axis_name</span><span class="p">,</span> <span class="n">axis_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create the normalization array for normalizing to the FEL intensity at the GMD</span>
<span class="sd">        :Parameter:</span>
<span class="sd">            data_array: np.ndarray</span>
<span class="sd">                data to be normalized</span>
<span class="sd">            axis_name:</span>
<span class="sd">                name of the axis along which to perform normalization</span>
<span class="sd">            axis_values:</span>
<span class="sd">                the bins of the axis_name provided.</span>
<span class="sd">        :Return:</span>
<span class="sd">            normalized_array: np.ndarray</span>
<span class="sd">                normalized version of the input array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Normalizing by GMD...&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the index of the normalization axis</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis_name</span><span class="p">)</span>

            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

            <span class="n">norm_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_GMD_histogram</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">axis_values</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">norm_array</span> <span class="o">=</span> <span class="n">norm_array</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">data_array_normalized</span> <span class="o">/</span> <span class="n">norm_array</span>
            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">data_array_normalized</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed the GMD normalization.&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">make_GMD_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_name</span><span class="p">,</span> <span class="n">axis_values</span><span class="p">):</span>  <span class="c1"># TODO: improve performance... its deadly slow!</span>

        <span class="n">gmd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;gmdBda&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
        <span class="n">axisDataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="n">axis_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

        <span class="n">norm_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis_values</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmd</span><span class="p">))):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gmd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">axis_values</span> <span class="o">-</span> <span class="n">axisDataframe</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">norm_array</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gmd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">norm_array</span>

<div class="viewcode-block" id="DldProcessor.normalizeAxisMean"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.normalizeAxisMean">[docs]</a>    <span class="k">def</span> <span class="nf">normalizeAxisMean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Normalize to the mean of the given axis.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            data_array: np.ndarray</span>
<span class="sd">                array to be normalized</span>
<span class="sd">            ax: int</span>
<span class="sd">                axis along which to normalize</span>
<span class="sd">        Returns:</span>
<span class="sd">            norm_array: np.ndarray</span>
<span class="sd">                normalized array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;normalizing mean on axis </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the index of the normalization axis</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">norm_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">norm_array</span> <span class="o">=</span> <span class="n">norm_array</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">norm_array</span> <span class="o">=</span> <span class="n">norm_array</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">data_array_normalized</span> <span class="o">/</span> <span class="n">norm_array</span>
            <span class="n">data_array_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data_array_normalized</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">data_array_normalized</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not normalize to </span><span class="si">{}</span><span class="s2"> histogram.</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">makeNormHistogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No bin axis </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> found. Cannot create normalization axis&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

            <span class="c1"># self.delaystageHistogram = numpy.histogram(self.delaystage[numpy.isfinite(self.delaystage)], bins)[0]</span>
            <span class="n">histBinner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
            <span class="n">histGrouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">histBinner</span><span class="p">])</span>
            <span class="c1"># self.pumpProbeHistogram = delaystageHistGrouped.count().compute()[&#39;bam&#39;].to_xarray().values.astype(np.float64)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">histGrouped</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># .astype(np.int32)</span>
            <span class="k">if</span> <span class="n">compute</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computing normalization array along </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pumpProbeTimeHistogram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Easy access to pump probe normalization array.</span>
<span class="sd">        Mostly for retrocompatibility&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">],</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computing normalization array along pumpProbeTime&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delayStageHistogram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Easy access to pump probe normalization array.</span>
<span class="sd">        Mostly for retrocompatibility&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;delayStage&#39;</span><span class="p">],</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computing normalization array along delayStage&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;delayStage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;delayStage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="s1">&#39;delayStage&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        
    <span class="c1"># ==========================</span>
    <span class="c1"># Binning</span>
    <span class="c1"># ==========================</span>

<div class="viewcode-block" id="DldProcessor.addFilter"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.addFilter">[docs]</a>    <span class="k">def</span> <span class="nf">addFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Filters the dataframes contained in the processor instance.</span>

<span class="sd">        Filters the columns of ``dd`` and ``ddMicrobunches`` dataframes in place.</span>

<span class="sd">        **Parameters**\n</span>
<span class="sd">        colname (str): name of the column in the dask dataframes</span>
<span class="sd">        lb (:obj:`float&#39;,optional):  lower bound of the filter</span>
<span class="sd">            if :None: (default), ignores lower boundary</span>
<span class="sd">        ub (:obj:`float&#39;,optional):  upper bound of the filter</span>
<span class="sd">            if :None: (default), ignores upper boundary</span>
<span class="sd">        </span>
<span class="sd">        **Attention**\n</span>
<span class="sd">        This is an irreversible process, since the dataframe gets overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ub</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ub</span><span class="p">]</span></div>

<div class="viewcode-block" id="DldProcessor.genBins"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.genBins">[docs]</a>    <span class="k">def</span> <span class="nf">genBins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">useStepSize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">forceEnds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates bins for use by binning functions.</span>
<span class="sd">        Can also be used to generate x axes.</span>

<span class="sd">        Binning is created using np.linspace (formerly was done with np.arange).</span>
<span class="sd">        The implementation allows to choose between setting a step size</span>
<span class="sd">        (useStepSize=True, default) or using a number of bins (useStepSize=False).</span>

<span class="sd">        In general, it is not possible to satisfy all 3 parameters: start, end, steps.</span>
<span class="sd">        For this reason, you can choose to give priority to the step size or to the</span>
<span class="sd">        interval size. In case forceEnds=False, the steps parameter is given</span>
<span class="sd">        priority and the end parameter is redefined, so the interval can actually</span>
<span class="sd">        be larger than expected. In case forceEnds = true, the stepSize is not</span>
<span class="sd">        enforced, and the interval is divided by the closest step that divides it</span>
<span class="sd">        cleanly. This of course only has meaning when choosing steps that do not</span>
<span class="sd">        cleanly divide the interval.</span>

<span class="sd">        **Parameters**\n</span>
<span class="sd">        start: float</span>
<span class="sd">            Position of first bin</span>
<span class="sd">        end: float</span>
<span class="sd">            Position of last bin (not included!)</span>
<span class="sd">        steps: float</span>
<span class="sd">            Define the bin size. If useStepSize=True (default),</span>
<span class="sd">            this is the step size, while if useStepSize=False, then this is the</span>
<span class="sd">            number of bins. In Legacy mode (force_legacy=True, or</span>
<span class="sd">            processor._LEGACY_MODE=True)</span>
<span class="sd">        useStepSize: bool | True</span>
<span class="sd">            Tells python to interpret steps as a step size if</span>
<span class="sd">            True, or as the number of steps if False</span>
<span class="sd">        forceEnds: bool | False</span>
<span class="sd">            Tells python to give priority to the end parameter</span>
<span class="sd">            rather than the step parameter (see above for more info)</span>
<span class="sd">        include_last: bool | True</span>
<span class="sd">            Closes the interval on the right when true. If</span>
<span class="sd">            using step size priority, will expand the interval to include</span>
<span class="sd">            the next value when true, will shrink the interval to contain all</span>
<span class="sd">            points within the bounds if false.</span>
<span class="sd">        force_legacy: bool | False</span>
<span class="sd">            If true, imposes old method for generating bins,</span>
<span class="sd">            based on np.arange instead of np.inspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>

        <span class="n">_LEGACY_BINNING</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># uses old method of binning</span>
        <span class="k">if</span> <span class="n">_LEGACY_BINNING</span> <span class="ow">or</span> <span class="n">force_legacy</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

        <span class="c1"># default interpretation of steps as the step size</span>
        <span class="c1"># needs Decimal library for dealing with float representation issues</span>
        <span class="k">elif</span> <span class="n">useStepSize</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">forceEnds</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)))</span> <span class="o">%</span>
                              <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">))))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">include_last</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span> <span class="o">-</span> \
                                     <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)))</span> <span class="o">%</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">))))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">-=</span> <span class="nb">float</span><span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)))</span> <span class="o">%</span>
                                      <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">))))</span>
                        <span class="n">include_last</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span> <span class="o">/</span> <span class="n">steps</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_last</span><span class="p">:</span>
                <span class="n">n_bins</span> <span class="o">-=</span> <span class="mi">1</span>
            
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">include_last</span><span class="p">)</span>

        <span class="c1"># non default interpretation of steps as the number of steps</span>
        <span class="c1"># /!\ remember to use n+1 if including the end point (default)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">steps</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number of steps must be a positive integer number&#39;</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">include_last</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bins</span></div>

<div class="viewcode-block" id="DldProcessor.addBinning"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.addBinning">[docs]</a>    <span class="k">def</span> <span class="nf">addBinning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">useStepSize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">forceEnds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">include_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compute_histograms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add binning of one dimension, to be then computed with ``computeBinnedData`` method.</span>

<span class="sd">        Creates a list of bin names, (binNameList) to identify the axis on</span>
<span class="sd">        which to bin the data. Output array dimensions order will be the same</span>
<span class="sd">        as in this list. The attribute binRangeList will contain the ranges of</span>
<span class="sd">        the binning used for the corresponding dimension.</span>

<span class="sd">        **Parameters**\n</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of the column to apply binning to. Possible column names are`:`</span>
<span class="sd">            posX, posY, dldTime, pumpProbeTime, dldDetector, etc.</span>
<span class="sd">        start: float</span>
<span class="sd">            Position of first bin</span>
<span class="sd">        end: float</span>
<span class="sd">            Position of last bin (not included!)</span>
<span class="sd">        steps: float</span>
<span class="sd">            The bin size, if useStepSize=True (default),</span>
<span class="sd">            this is the step size, while if useStepSize=False, then this is the</span>
<span class="sd">            number of bins. In Legacy mode (force_legacy=True, or</span>
<span class="sd">            processor._LEGACY_MODE=True)</span>
<span class="sd">        useStepSize: bool | True</span>
<span class="sd">            Tells Python how to interpret steps.</span>
<span class="sd">            </span>
<span class="sd">            :True: interpret steps as a step size.</span>
<span class="sd">            :False: interpret steps as the number of steps.</span>
<span class="sd">        forceEnds: bool | False</span>
<span class="sd">            Tells python to give priority to the end parameter</span>
<span class="sd">            rather than the step parameter (see genBins for more info)</span>
<span class="sd">        include_last: bool | True</span>
<span class="sd">            Closes the interval on the right when true. If</span>
<span class="sd">            using step size priority, will expand the interval to include</span>
<span class="sd">            the next value when true, will shrink the interval to contain all</span>
<span class="sd">            points within the bounds if false.</span>
<span class="sd">        force_legacy: bool | False</span>
<span class="sd">            :True: use np.arange method to generate bins.</span>
<span class="sd">            :False: use np.linspace method to generate bins.</span>
<span class="sd">                </span>
<span class="sd">        **Return**\n</span>
<span class="sd">        axes: numpy array</span>
<span class="sd">            axis of the binned dimesion. The points defined on this axis are the middle points of</span>
<span class="sd">            each bin.</span>
<span class="sd">                </span>
<span class="sd">        **Note**\n</span>
<span class="sd">        If the name is &#39;pumpProbeTime&#39;: sets self.delaystageHistogram for normalization.</span>
<span class="sd">        </span>
<span class="sd">        .. seealso::</span>
<span class="sd">        </span>
<span class="sd">          ``computeBinnedData`` Method to compute all bins created with this function.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># write the parameters to the bin list:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dldTime&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_IN_NS</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">start</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useStepSize</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># division by 8 is necessary since the first 3 bits of the channel where these values are</span>
                <span class="c1"># taken from is used for other purpouses. Therefore the real tof step is:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">steps</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span> 
                <span class="n">steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genBins</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">useStepSize</span><span class="p">,</span> <span class="n">forceEnds</span><span class="p">,</span> <span class="n">include_last</span><span class="p">,</span> <span class="n">force_legacy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dldTime&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_IN_NS</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOF_STEP_TO_NS</span>

        <span class="c1"># TODO: could be improved for nonlinear scales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">,</span> <span class="s1">&#39;delayStage&#39;</span><span class="p">]:</span>
            <span class="c1"># add the normalization histogram to the histograms dictionary. computes them if requested, otherwise</span>
            <span class="c1"># only assigned the dask calculations for later computation.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeNormHistogram</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="n">compute_histograms</span><span class="p">)</span>
            <span class="c1"># These can be accessed in the old method through the class properties pumpProbeHistogram and delayStageHistogram</span>

        <span class="k">return</span> <span class="n">axes</span></div>

<div class="viewcode-block" id="DldProcessor.resetBins"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.resetBins">[docs]</a>    <span class="k">def</span> <span class="nf">resetBins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reset the bin list &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histograms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="DldProcessor.computeBinnedData"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.computeBinnedData">[docs]</a>    <span class="k">def</span> <span class="nf">computeBinnedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveAs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_xarray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_64bit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fast_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usePbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use the bin list to bin the data.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters**\n</span>
<span class="sd">        saveAs: str | None</span>
<span class="sd">            full file name where to save the result (forces return_xarray</span>
<span class="sd">            to be true).</span>
<span class="sd">        return_xarray: bool</span>
<span class="sd">            if true, returns and xarray with all available axis and metadata</span>
<span class="sd">            information attached, otherwise a numpy.array.</span>
<span class="sd">        </span>
<span class="sd">        **Returns**\n</span>
<span class="sd">        result: numpy.array or xarray.DataArray</span>
<span class="sd">            A numpy array of float64 values. Number of bins defined will define the</span>
<span class="sd">            dimensions of such array.</span>

<span class="sd">        **Notes**\n</span>
<span class="sd">        postProcess method must be used before computing the binned data if binning</span>
<span class="sd">        along pumpProbeDelay or polar k-space coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">return_xarray</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">return_xarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RETURN_XARRAY</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">return_xarray</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="k">def</span> <span class="nf">analyzePart</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Function called by each thread of the analysis.</span>

<span class="sd">            Old deprecated method</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">grouperList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">)):</span>
                <span class="n">grouperList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouperList</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">())[</span><span class="s1">&#39;microbunchId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># new binner for a partition, not using the Pandas framework. It should</span>
        <span class="c1"># be faster!</span>
        <span class="k">def</span> <span class="nf">analyzePartNumpy</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Function called by each thread of the analysis.</span>
<span class="sd">            </span>
<span class="sd">            **Parameter**\n</span>
<span class="sd">            part: partition</span>
<span class="sd">                partition to process.</span>
<span class="sd">            </span>
<span class="sd">            **Returns**\n</span>
<span class="sd">            res: numpy array</span>
<span class="sd">                binned array calculated from this partition.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># get the data as numpy:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">values</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># create array of columns to be used for binning</span>
            <span class="n">colsToBin</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">binName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">binName</span><span class="p">)</span>
                <span class="n">colsToBin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="c1">#            # create the array with the bins and bin ranges</span>
            <span class="c1">#            numBins = []</span>
            <span class="c1">#            ranges = []</span>
            <span class="c1">#            for i in range(0, len(colsToBin)):</span>
            <span class="c1">#                # need to subtract 1 from the number of bin ranges</span>
            <span class="c1">#                numBins.append(len(self.binRangeList[i]) - 1)</span>
            <span class="c1">#                ranges.append(</span>
            <span class="c1">#                    (self.binRangeList[i].min(),</span>
            <span class="c1">#                     self.binRangeList[i].max()))</span>
            <span class="c1">#            # now we are ready for the analysis with numpy:</span>
            <span class="c1">#            res, edges = np.histogramdd(</span>
            <span class="c1">#                vals[:, colsToBin], bins=numBins, range=ranges)</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">vals</span><span class="p">[:,</span> <span class="n">colsToBin</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># prepare the partitions for the calculation in parallel</span>
        <span class="n">calculatedResults</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">_VERBOSE</span><span class="p">:</span>
            <span class="n">warnString</span> <span class="o">=</span> <span class="s2">&quot;always&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnString</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">warnString</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">npartitions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_CORES</span><span class="p">),</span><span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">usePbar</span><span class="p">):</span>
                <span class="n">resultsToCalculate</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># process the data in blocks of n partitions (given by the number</span>
                <span class="c1"># of cores):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_CORES</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">npartitions</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_partition</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
                    <span class="n">resultsToCalculate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">analyzePartNumpy</span><span class="p">)(</span><span class="n">part</span><span class="p">))</span>

                <span class="c1"># now do the calculation on each partition (using the dask</span>
                <span class="c1"># framework):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultsToCalculate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1">#                print(&quot;computing partitions &quot; + str(i) + &quot; to &quot; + str(i + j) + &quot; of &quot; + str(</span>
                    <span class="c1">#                    self.dd.npartitions) + &quot;. partitions calculated in parallel: &quot; + str(</span>
                    <span class="c1">#                    len(resultsToCalculate)))</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">resultsToCalculate</span><span class="p">)</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span> <span class="o">+</span> <span class="n">result</span>
                    <span class="n">calculatedResults</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">total</span>
                <span class="k">del</span> <span class="n">resultsToCalculate</span>

        <span class="c1"># we now need to add them all up (single core):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">calculatedResults</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">calculatedResults</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">r</span>

        <span class="k">if</span> <span class="n">force_64bit</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_xarray</span> <span class="ow">or</span> <span class="n">saveAs</span><span class="p">:</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_metadata</span><span class="p">:</span> 
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;forced to skip metadata creation&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">fast_mode</span><span class="o">=</span><span class="n">fast_metadata</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed creating metadata: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">res_to_xarray</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">saveAs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># TODO: Make saving function</span>
            <span class="c1"># self.save_binned(result, saveName, path=savePath, mode=&#39;w&#39;)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="DldProcessor.get_metadata"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Creates a dictionary with the most relevant metadata.</span>

<span class="sd">        **Args**\n</span>
<span class="sd">        fast_mode: bool | False</span>
<span class="sd">            if False skips the heavy computation steps which take a long time.</span>
<span class="sd">        </span>
<span class="sd">        **Returns**\n</span>
<span class="sd">        metadata: dict</span>
<span class="sd">            dictionary with metadata information</span>
<span class="sd">        # TODO: distribute metadata generation in the appropriate methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating metadata...&#39;</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startEndTime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">startEndTime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fast_mode</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;timeStamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;timeStamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;timing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acquisition start&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                              <span class="s1">&#39;acquisition stop&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                              <span class="s1">&#39;acquisition duration&#39;</span><span class="p">:</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                              <span class="c1"># &#39;bin array creation&#39;: datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;),</span>
                              <span class="p">}</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">parse_category</span><span class="p">(</span><span class="s1">&#39;processor&#39;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;DAQ channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">parse_category</span><span class="p">(</span><span class="s1">&#39;DAQ channels&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fast_mode</span><span class="p">:</span>
            <span class="n">pulseIdFrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;macroBunchPulseId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">pulseIdTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;macroBunchPulseId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pulseIdFrom</span><span class="p">,</span> <span class="n">pulseIdTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;runNumber&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runNumber</span><span class="p">,</span>
            <span class="s1">&#39;macroBunchPulseIdInterval&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pulseIdFrom</span><span class="p">,</span> <span class="n">pulseIdTo</span><span class="p">],</span>
            <span class="s1">&#39;nMacrobunches&#39;</span><span class="p">:</span> <span class="n">pulseIdTo</span> <span class="o">-</span> <span class="n">pulseIdFrom</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">][</span><span class="s1">&#39;nElectrons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numOfElectrons</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">][</span><span class="s1">&#39;electronsPerMacrobunch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electronsPerMacrobunch</span><span class="p">,</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># TODO: find smarter solution</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delaystageHistogram&#39;</span><span class="p">):</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="s1">&#39;delayStage&#39;</span><span class="p">,</span> <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delaystageHistogram</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pumpProbeHistogram&#39;</span><span class="p">):</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="s1">&#39;pumpProbeDelay&#39;</span><span class="p">,</span> <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pumpProbeTimeHistogram</span><span class="p">}</span>

        <span class="c1"># if not fast_mode:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         axis_values = []</span>
        <span class="c1">#         ax_len = 0</span>
        <span class="c1">#         for ax, val in zip(self.binNameList, self.binAxesList):</span>
        <span class="c1">#             if len(val) &gt; ax_len:</span>
        <span class="c1">#                 ax_len = len(val)</span>
        <span class="c1">#                 axis_name = ax</span>
        <span class="c1">#                 axis_values = val</span>
        <span class="c1">#</span>
        <span class="c1">#         GMD_norm = self.make_GMD_histogram(axis_name, axis_values)</span>
        <span class="c1">#         metadata[&#39;histograms&#39;][&#39;GMD&#39;] = {&#39;axis&#39;: axis_name, &#39;histogram&#39;: GMD_norm}</span>
        <span class="c1">#     except Exception as e:</span>
        <span class="c1">#         print(&quot;Couldn&#39;t find GMD channel for making GMD normalization histograms\nError: {}&quot;.format(e))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...done!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metadata</span></div>

<div class="viewcode-block" id="DldProcessor.res_to_xarray_old"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.res_to_xarray_old">[docs]</a>    <span class="k">def</span> <span class="nf">res_to_xarray_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">fast_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a BinnedArray (xarray subclass) out of the given numpy.array.</span>
<span class="sd">        </span>
<span class="sd">        **Parameters**\n</span>
<span class="sd">        res: np.array</span>
<span class="sd">            nd array of binned data</span>
<span class="sd">        fast_mode: bool default True</span>
<span class="sd">            if True, it skips the creation of metadata element which require computation.</span>
<span class="sd">        </span>
<span class="sd">        **Returns**\n</span>
<span class="sd">        ba: BinnedArray (xarray)</span>
<span class="sd">            an xarray-like container with binned data, axis, and all available metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="p">):</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

        <span class="n">ba</span> <span class="o">=</span> <span class="n">BinnedArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">default_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dldTime&#39;</span><span class="p">:</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;delayStage&#39;</span><span class="p">:</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;pumpProbeDelay&#39;</span><span class="p">:</span> <span class="s1">&#39;ps&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">default_units</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">units</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startEndTime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">startEndTime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fast_mode</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;timeStamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;timeStamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;timing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acquisition start&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                              <span class="s1">&#39;acquisition stop&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                              <span class="s1">&#39;acquisition duration&#39;</span><span class="p">:</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
                              <span class="s1">&#39;bin array creation&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                              <span class="p">}</span>
        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">parse_category</span><span class="p">(</span><span class="s1">&#39;processor&#39;</span><span class="p">)</span>
        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DAQ channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">parse_category</span><span class="p">(</span><span class="s1">&#39;DAQ channels&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pulseIdFrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;macroBunchPulseId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">pulseIdTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;macroBunchPulseId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pulseIdFrom</span><span class="p">,</span> <span class="n">pulseIdTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulseIdInterval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;runNumber&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runNumber</span><span class="p">,</span>
            <span class="s1">&#39;macroBunchPulseIdInterval&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pulseIdFrom</span><span class="p">,</span> <span class="n">pulseIdTo</span><span class="p">],</span>
            <span class="s1">&#39;nMacrobunches&#39;</span><span class="p">:</span> <span class="n">pulseIdTo</span> <span class="o">-</span> <span class="n">pulseIdFrom</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">][</span><span class="s1">&#39;nElectrons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numOfElectrons</span>
            <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">][</span><span class="s1">&#39;electronsPerMacrobunch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electronsPerMacrobunch</span><span class="p">,</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># TODO: find smarter solution</span>

        <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delaystageHistogram&#39;</span><span class="p">):</span>
            <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="s1">&#39;delayStage&#39;</span><span class="p">,</span> <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delaystageHistogram</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pumpProbeHistogram&#39;</span><span class="p">):</span>
            <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="s1">&#39;pumpProbeDelay&#39;</span><span class="p">,</span> <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pumpProbeTimeHistogram</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fast_mode</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">axis_values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ax_len</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ax_len</span><span class="p">:</span>
                        <span class="n">ax_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="n">axis_name</span> <span class="o">=</span> <span class="n">ax</span>
                        <span class="n">axis_values</span> <span class="o">=</span> <span class="n">val</span>

                <span class="n">GMD_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_GMD_histogram</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">axis_values</span><span class="p">)</span>
                <span class="n">ba</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;GMD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="n">axis_name</span><span class="p">,</span> <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="n">GMD_norm</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find GMD channel for making GMD normalization histograms</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ba</span></div>

<div class="viewcode-block" id="DldProcessor.computeBinnedDataMulti"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.computeBinnedDataMulti">[docs]</a>    <span class="k">def</span> <span class="nf">computeBinnedDataMulti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use the bin list to bin the data. Cluster-compatible version (Maciej Dendzik)</span>
<span class="sd">        </span>
<span class="sd">        **Parameters**\n</span>
<span class="sd">        saveName: str | None</span>
<span class="sd">            filename</span>
<span class="sd">        savePath: str | None</span>
<span class="sd">            file path</span>
<span class="sd">        rank: int | None</span>
<span class="sd">            Rank number of cluster computer</span>
<span class="sd">        size: int | None</span>
<span class="sd">            Size of partition</span>
<span class="sd">        </span>
<span class="sd">        **Return**\n</span>
<span class="sd">        result: numpy array</span>
<span class="sd">            A numpy array of float64 values. The number of bins determines the</span>
<span class="sd">            dimensionality of the output array.</span>

<span class="sd">        **Notes**\n</span>
<span class="sd">        postProcess method must be used before computing the binned data if binning</span>
<span class="sd">        is applied along pumpProbeDelay or polar k-space coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">analyzePart</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Function called by each thread of the analysis.&quot;&quot;&quot;</span>
            <span class="n">grouperList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">)):</span>
                <span class="n">grouperList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouperList</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">())[</span><span class="s1">&#39;microbunchId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># new binner for a partition, not using the Pandas framework. It should</span>
        <span class="c1"># be faster!</span>
        <span class="k">def</span> <span class="nf">analyzePartNumpy</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Function called by each thread of the analysis. This now should be faster. &quot;&quot;&quot;</span>
            <span class="c1"># get the data as numpy:</span>
            <span class="c1"># vals = part.values</span>
            <span class="c1"># cols = part.columns.values</span>
            <span class="c1"># create array of columns to be used for binning</span>

            <span class="n">colsToBin</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">binName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">binName</span><span class="p">)</span>
                <span class="n">colsToBin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="c1"># create the array with the bins and bin ranges</span>
            <span class="n">numBins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colsToBin</span><span class="p">)):</span>
                <span class="n">numBins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="c1"># now we are ready for the analysis with numpy:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span>
                <span class="n">vals</span><span class="p">[:,</span> <span class="n">colsToBin</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">numBins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># prepare the partitions for the calculation in parallel</span>
        <span class="n">calculatedResults</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">npartitions</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="n">resultsToCalculate</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># process the data in blocks of n partitions (given by the number of cores):</span>
            <span class="c1"># for j in range(0, self.N_CORES):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">rank</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">npartitions</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">partval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_partition</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">partcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">get_partition</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">analyzePartNumpy</span><span class="p">(</span><span class="n">partval</span><span class="p">,</span> <span class="n">partcol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">+=</span> <span class="n">analyzePartNumpy</span><span class="p">(</span><span class="n">partval</span><span class="p">,</span> <span class="n">partcol</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;computing partitions &quot;</span> <span class="o">+</span>
                  <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span>
                      <span class="n">rank</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s2">&quot; of &quot;</span> <span class="o">+</span>
                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="o">.</span><span class="n">npartitions</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s2">&quot;. partitions calculated in parallel: &quot;</span> <span class="o">+</span>
                  <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">saveName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_binned</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">saveName</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">savePath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="DldProcessor.save_binned"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.save_binned">[docs]</a>    <span class="k">def</span> <span class="nf">save_binned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binnedData</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save a binned numpy array to h5 file. The file includes the axes</span>
<span class="sd">        (taken from the scheduled bins) and the delay stage histogram, if it exists.</span>

<span class="sd">        **Parameters**\n</span>
<span class="sd">        binnedData: numpy array</span>
<span class="sd">            Binned multidimensional data.</span>
<span class="sd">        file_name: str</span>
<span class="sd">            Name of the saved file. The extension &#39;.h5&#39; is automatically added.</span>
<span class="sd">        path: str | None</span>
<span class="sd">            File path.</span>
<span class="sd">        mode: str | &#39;w&#39;</span>
<span class="sd">            Write mode of h5 file (&#39;w&#39; = write).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_abort</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_H5_DIR</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># test if the path exists...</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;The folder </span><span class="si">{}</span><span class="s2"> doesn&#39;t exist,&quot;</span>
                           <span class="s2">&quot;do you want to create it? [y/n]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_abort</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.h5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">filename</span><span class="p">):</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;A file named </span><span class="si">{}</span><span class="s2"> already exists. Overwrite it? &quot;</span>
                           <span class="s2">&quot;[y/n or r for rename]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;ja&#39;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;nein&#39;</span><span class="p">]:</span>
                <span class="n">_abort</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;choose a new name:&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_abort</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5File</span><span class="p">:</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saving data to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">filename</span><span class="p">))</span>

                <span class="k">if</span> <span class="s1">&#39;pumpProbeTime&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">)</span>
                    <span class="n">pp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">binnedData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

                <span class="k">elif</span> <span class="s1">&#39;delayStage&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;delayStage&#39;</span><span class="p">)</span>
                    <span class="n">pp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">binnedData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pp_data</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Saving data</span>

                <span class="n">ff</span> <span class="o">=</span> <span class="n">h5File</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;frames&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">pp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># in case there is no time axis, make a single dataset</span>
                    <span class="n">ff</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;f</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">binnedData</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># otherwise make a dataset for each time frame.</span>
                        <span class="n">ff</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;f</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">pp_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

                <span class="c1"># Saving axes</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">h5File</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;axes&quot;</span><span class="p">)</span>
                <span class="c1"># aa.create_dataset(&#39;axis_order&#39;, data=self.binNameList)</span>
                <span class="n">ax_n</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">binName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">binName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">,</span> <span class="s1">&#39;delayStage&#39;</span><span class="p">]:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ax0 - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binName</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">binName</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ax</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax_n</span><span class="p">,</span> <span class="n">binName</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binAxesList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">binName</span>
                        <span class="n">ax_n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Saving delay histograms</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">h5File</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;histograms&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delaystageHistogram&#39;</span><span class="p">):</span>
                    <span class="n">hh</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                        <span class="s1">&#39;delaystageHistogram&#39;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delaystageHistogram</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pumpProbeHistogram&#39;</span><span class="p">):</span>
                    <span class="n">hh</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                        <span class="s1">&#39;pumpProbeHistogram&#39;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pumpProbeTimeHistogram</span><span class="p">)</span></div>

<div class="viewcode-block" id="DldProcessor.load_binned"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.load_binned">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_binned</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ret_type</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load an HDF5 file saved with ``save_binned()`` method.</span>
<span class="sd">        wrapper for function utils.load_binned_h5()</span>

<span class="sd">        **Parameters**\n</span>
<span class="sd">        file_name: str</span>
<span class="sd">            name of the file to load, including full path</span>
<span class="sd">        mode: str | &#39;r&#39;</span>
<span class="sd">            Read mode of h5 file (&#39;r&#39; = read).</span>
<span class="sd">        ret_type: str | &#39;list&#39;,&#39;dict&#39;</span>
<span class="sd">            output format for axes and histograms:</span>
<span class="sd">            &#39;list&#39; generates a list of arrays, ordered as</span>
<span class="sd">            the corresponding dimensions in data. &#39;dict&#39;</span>
<span class="sd">            generates a dictionary with the names of each axis.</span>

<span class="sd">        **Returns**\n</span>
<span class="sd">        data: numpy array</span>
<span class="sd">            Multidimensional data read from h5 file.</span>
<span class="sd">        axes: numpy array</span>
<span class="sd">            The axes values associated with the read data.</span>
<span class="sd">        hist: numpy array</span>
<span class="sd">            Histogram values associated with the read data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">misc</span><span class="o">.</span><span class="n">load_binned_h5</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">ret_type</span><span class="o">=</span><span class="n">ret_type</span><span class="p">)</span></div>

    <span class="c1"># % retro-compatibility functions and deprecated methods</span>

<div class="viewcode-block" id="DldProcessor.load_settings"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.load_settings">[docs]</a>    <span class="k">def</span> <span class="nf">load_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_file_name</span><span class="p">,</span> <span class="n">preserve_path</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrocompatibility naming&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadSettings</span><span class="p">(</span><span class="n">settings_file_name</span><span class="p">,</span> <span class="n">preserve_path</span><span class="o">=</span><span class="n">preserve_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="DldProcessor.deleteBinners"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.deleteBinners">[docs]</a>    <span class="k">def</span> <span class="nf">deleteBinners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; **[DEPRECATED]** use resetBins() instead</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: deleteBinners method has been renamed to resetBins.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetBins</span><span class="p">()</span></div>

<div class="viewcode-block" id="DldProcessor.readDataframesParquet"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.readDataframesParquet">[docs]</a>    <span class="k">def</span> <span class="nf">readDataframesParquet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; **[DEPRECATED]** Load data from a dask Parquet dataframe.</span>
<span class="sd">        Use readDataframesParquet instead.</span>

<span class="sd">        **Parameter**\n</span>
<span class="sd">        fileName: str | None</span>
<span class="sd">            name (including path) of the folder containing</span>
<span class="sd">            parquet files where the data was saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: remove this function once retro-compatibility is ensured</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;WARNING: readDataframesParquet is being removed.</span><span class="se">\n</span><span class="s1">Use readDataframes instead: Default behaviour is now &#39;</span>
            <span class="s1">&#39;parqet.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39; Specify format=&quot;h5&quot; for legacy use.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readDataframes</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span></div>

    <span class="c1"># ==================</span>
    <span class="c1"># DEPRECATED METHODS</span>
    <span class="c1"># ==================</span>

<div class="viewcode-block" id="DldProcessor.save2hdf5"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.save2hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">save2hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binnedData</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;default.hdf5&#39;</span><span class="p">,</span>
                  <span class="n">normalizedData</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; **[DEPRECATED]** Store the binned data in a hdf5 file.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            binneddata : pd.DataFrame</span>
<span class="sd">                binned data with bins in dldTime, posX, and posY (and if to be</span>
<span class="sd">                normalized, binned in detectors).</span>
<span class="sd">            filename : str | &#39;default.hdf5&#39;</span>
<span class="sd">                name of the file.</span>
<span class="sd">            path : str | None | None</span>
<span class="sd">                path to the location where to save the hdf5 file. If `None`, uses the default value</span>
<span class="sd">                defined in SETTINGS.ini</span>
<span class="sd">            normalizedData : bool | None</span>
<span class="sd">                Normalized data for both detector, so it should be a 3D array</span>
<span class="sd">                (posX, posY, detectorID).</span>
<span class="sd">            overwrite : bool | False</span>
<span class="sd">                :True: overwrites existing files with matching filename.</span>
<span class="sd">                :False: no overwriting of files</span>

<span class="sd">        :Example:</span>
<span class="sd">            Normalization given, for example take it from run 18440.</span>
<span class="sd">        ::</span>

<span class="sd">            processor.readRun(18440)</span>
<span class="sd">            processor.addBinning(&#39;posX&#39;, 500, 1000, 2)</span>
<span class="sd">            processor.addBinning(&#39;posY&#39;, 500, 1000, 2)</span>
<span class="sd">            processor.addBinning(&#39;dldDetectorId&#39;, -1, 2, 1)</span>
<span class="sd">            norm = processor.computeBinnedData()</span>
<span class="sd">            norm = np.nan_to_num(norm)</span>
<span class="sd">            norm[norm&lt;10]=1 # 10 or smaller seems to be outside of detector</span>
<span class="sd">            norm[:,:,0][norm[:,:,0] &gt;= 10]/=norm[:,:,0][norm[:,:,0] &gt;= 10].mean()</span>
<span class="sd">            norm[:,:,1][norm[:,:,1] &gt;= 10]/=norm[:,:,1][norm[:,:,1] &gt;= 10].mean()</span>
<span class="sd">            norm[norm&lt;0.05]=0.1</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception Wrong dimension: if data from binnedData has dimensions different from 4</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: generalise this function for different data input shapes or bin orders</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_H5_DIR</span>

        <span class="k">if</span> <span class="n">normalizedData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">binnedData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong dimension&#39;</span><span class="p">)</span>
            <span class="n">data2hdf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">binnedData</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="c1"># normalize for all time binns</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binnedData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># normalize for both detectors (0 and 1)</span>

                <span class="n">data2hdf5</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">binnedData</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">normalizedData</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                <span class="n">data2hdf5</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">binnedData</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span>
                                      <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">/</span> <span class="n">normalizedData</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># detector binned? -&gt; sum together</span>
            <span class="k">if</span> <span class="n">binnedData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">data2hdf5</span> <span class="o">=</span> <span class="n">binnedData</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">binnedData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong dimension&#39;</span><span class="p">)</span>
                <span class="c1"># print(binnedData.transpose((1,2).shape)</span>
                <span class="n">data2hdf5</span> <span class="o">=</span> <span class="n">binnedData</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># create file and save data</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w-&quot;</span>  <span class="c1"># fail if file exists</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s2">&quot;experiment/xyt_data&quot;</span><span class="p">,</span>
            <span class="n">data2hdf5</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

        <span class="n">dset</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2hdf5</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created file &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">addBinningOld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">useStepSize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">include_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; **[DEPRECATED]** Add binning of one dimension,</span>
<span class="sd">        to be then computed with ``computeBinnedData`` method.</span>

<span class="sd">        Creates a list of bin names, (binNameList) to identify the axis on</span>
<span class="sd">        which to bin the data. Output array dimensions order will be the same</span>
<span class="sd">        as in this list. The attribute binRangeList will contain the ranges of</span>
<span class="sd">        the binning used for the corresponding dimension.</span>

<span class="sd">        Binning is created using np.linspace (formerly was done with np.arange).</span>
<span class="sd">        The implementation allows to choose between setting a step size</span>
<span class="sd">        (useStepSize=True, default) or using a number of bins (useStepSize=False).</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            name : str</span>
<span class="sd">                Name of the column to bin to. Possible column names are:</span>
<span class="sd">                posX, posY, dldTime, pumpProbeTime, dldDetector, etc.</span>
<span class="sd">            start : float</span>
<span class="sd">                Position of first bin</span>
<span class="sd">            end : float</span>
<span class="sd">                Position of last bin (not included!)</span>
<span class="sd">            steps : float</span>
<span class="sd">                Define the bin size. If useStepSize=True (default),</span>
<span class="sd">                this is the step size, while if useStepSize=False, then this is the</span>
<span class="sd">                number of bins. In Legacy mode (force_legacy=True, or</span>
<span class="sd">                processor._LEGACY_MODE=True)</span>
<span class="sd">            force_legacy : bool</span>
<span class="sd">                if true, imposes old method for generating bins,</span>
<span class="sd">                based on np.arange instead of np.linspace.</span>

<span class="sd">        See also:</span>
<span class="sd">            computeBinnedData : Method to compute all bins created with this function.</span>

<span class="sd">        Notes:</span>
<span class="sd">            If the name is &#39;pumpProbeTime&#39;: sets self.delaystageHistogram for normalization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_LEGACY_BINNING</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">_LEGACY_BINNING</span> <span class="ow">or</span> <span class="n">force_legacy</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">useStepSize</span><span class="p">:</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">%</span> <span class="n">steps</span>
            <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">rest</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_last</span><span class="p">:</span>
                <span class="n">n_bins</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">include_last</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">steps</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number of steps must be a positive integer number&#39;</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">include_last</span><span class="p">)</span>

        <span class="c1"># write the parameters to the bin list:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binNameList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binRangeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">):</span>
            <span class="c1"># self.delaystageHistogram = numpy.histogram(self.delaystage[numpy.isfinite(self.delaystage)], bins)[0]</span>
            <span class="n">delaystageHistBinner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="p">[</span><span class="s1">&#39;pumpProbeTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
            <span class="n">delaystageHistGrouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddMicrobunches</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="n">delaystageHistBinner</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delaystageHistogram</span> <span class="o">=</span> <span class="n">delaystageHistGrouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()[</span><span class="s1">&#39;bam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># TODO: discuss and improve the delay stage histogram normalization.</span>

<div class="viewcode-block" id="DldProcessor.read_h5"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.DldProcessor.read_h5">[docs]</a>    <span class="k">def</span> <span class="nf">read_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5FilePath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; [DEPRECATED] Read the h5 file at given path and return the contained data.</span>

<span class="sd">        :parameters:</span>
<span class="sd">            h5FilePaht : str</span>
<span class="sd">                Path to the h5 file to read.</span>

<span class="sd">        :returns:</span>
<span class="sd">            result : np.ndarray</span>
<span class="sd">                array containing binned data</span>
<span class="sd">            axes : dict</span>
<span class="sd">                dictionary with axes data labeled by axes name</span>
<span class="sd">            histogram : np.array</span>
<span class="sd">                array of time normalization data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">h5FilePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;frames&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;frames&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">histogram</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;pumpProbeHistogram&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">]:</span>
                <span class="n">histogram</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;pumpProbeHistogram&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;delaystageHistogram&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">]:</span>
                <span class="n">histogram</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;histograms&#39;</span><span class="p">][</span><span class="s1">&#39;delaystageHistogram&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ax_label</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]:</span>
                <span class="n">ax_name</span> <span class="o">=</span> <span class="n">ax_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">][</span><span class="n">ax_label</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">histogram</span></div></div>

<div class="viewcode-block" id="SettingsInitializationError"><a class="viewcode-back" href="../../library/DldProcessor.html#processor.DldProcessor.SettingsInitializationError">[docs]</a><span class="k">class</span> <span class="nc">SettingsInitializationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, momentoscope team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>